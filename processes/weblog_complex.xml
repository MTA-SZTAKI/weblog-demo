<?xml version="1.0" encoding="UTF-8"?>
<process xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <source>
    <weblog-file-source name="cli" />
  </source>

  <target>
    <database-target connection-name="weblog_demo">
      <truncate-query>
          truncate table weblog_event_incoming
      </truncate-query>

      <insert-query numeric-fields-to-convert="status">
        insert into weblog_event_incoming (
            virtual_host, request_timestamp, event_group, event,
            visitor_ip, visitor_hostname, visitor_ip_resolv_time, 
            visitor_ip_resolv_expire, 
            inet_protocol, http_method, http_status_code,
            http_request, http_request_cookie, http_response_cookie, 
            request_url, request_url_parameter, request_url_extension,  
            referer_url, referer_url_parameter, referer_url_extension, 
            agent_string, agent_resolv_time, agent_type, agent_device, agent_processor, agent_sw_platform, agent_name, 
            agent_version, agent_language, agent_os, agent_os_version, agent_os_distro, agent_layout_engine, agent_layout_resolution,
            auth_user, bytes_sent
        ) values (
            :virtualhost, to_timestamp(:time, 'DD/Mon/YYYY:HH24:MI:SS'), :eventGroup, :event,
            :clientip, :domainName, current_timestamp,
            to_timestamp(:lookupExpiry,'YYYY-MM-DD HH24:MI:SS'),
            :requestProtType, :requestProtMethod, :status,
            :request, :requestCookie, :responseCookie, 
            :requestUrl, :requestUrlParameter, :requestUrlExtension,  
            :refererUrl, :refererUrlParameter, :refererUrlExtension,  
            :userAgent, current_timestamp, :userAgentAgentType, :userAgentDevice, :userAgentProcessor, :userAgentSWPlatform, :userAgentAgentName,
            :userAgentAgentVersion, :userAgentLang, :userAgentOS, :userAgentOSVersion, :userAgentOSDistro, :userAgentLayoutEngine, :userAgentLayoutRes,
            :user, case when :bytesSent='-' then 0 else cast (:bytesSent as numeric) end
        )
      </insert-query>
    </database-target> 
  </target>

  <error-target>
    <database-target connection-name="weblog_demo">
      <truncate-query>
        truncate table weblog_event_incoming_err
      </truncate-query>
      <insert-query>
       insert into weblog_event_incoming_err ( 
           error_time, server_host, request_timestamp, class_name, field, field_value, 
           details, document_url, document_line, document_column
       ) values (
          current_timestamp, :serverHost, to_timestamp(:requestTime, 'YYYY.MM.DD HH24:MI:SS'), 
          :class_name, :field, :value, :details, :document_url, :document_line, :document_column
       )
      </insert-query>
    </database-target>
  </error-target>

  <blocks>
    <block-ref id="weblogparser:parse" />

    <!-- Consider relevant hits only -->
    <block-ref id="weblog-events:determine.basic-events" />
    <block-ref id="weblog-events:filter.eventless-records" />

    <!-- Normalize request url -->
    <copy apply-to="requestUrl" from="requestUrlFull" />

    <block-ref id="url-normalize:main" version="2.0">
      <map from="requestUrl" to="url" />
    </block-ref>

    <!-- Normalize referer url -->
    <if>
      <equals apply-to="refererUrlFull" value="-" />
      <then>
        <set-null apply-to="refererUrlFull" />
      </then>
    </if>
    <copy apply-to="refererUrl" from="refererUrlFull" />
    <block-ref id="url-normalize:main" version="2.0">
      <map from="refererUrl" to="url" />
    </block-ref>

    <!-- Reverse DNS lookup -->
    <copy apply-to="ipAddress" from="clientip" />
    <dnsresolve connection-name="dnsCache" />

    <!-- Identify parts of user agent string -->
    <block-ref id="weblog-useragent:weblog-useragent.identify.parts">
      <pass fields="userAgentAgentName userAgentAgentType userAgentAgentVersion userAgentLang userAgentOS 
                    userAgentOSVersion userAgentOSDistro userAgentLayoutEngine userAgentLayoutRes userAgentDevice 
                    userAgentProcessor userAgentSWPlatform"/>
    </block-ref>

    <if>
      <equals apply-to="bytesSent" value="-" />
      <then>
        <set apply-to="bytesSent" value="0" />
      </then>
    </if>

  </blocks>
</process>
