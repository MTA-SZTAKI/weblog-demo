<?xml version="1.0" encoding="UTF-8"?>
<process xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <source>
    <weblog-file-source name="cli"/>
  </source>

  <target>
    <database-target connection-name="weblog_demo">
      <truncate-query>
        truncate table weblog_event_incoming_p2
      </truncate-query>
      <insert-query numeric-fields-to-convert="bytesSent,status,visitorRefererId">
        insert into weblog_event_incoming_p2 (
            virtual_host, request_time, event_group, event,
            visitor_ip, 
            http_status_code, inet_protocol, http_method, 
            http_request,  
            request_url, request_url_parameter, request_url_extension,
            auth_user, bytes_sent
        )
        values (
           :virtualhost, to_timestamp(:time,'DD/Mon/YYYY:HH24:MI:SS'), :eventGroup, :event,
           :clientip,
           :status, :requestProtType, :requestProtMethod,
           :request,  
           :requestUrl, :requestUrlParameter, :requestUrlExtension, 
           :user, :bytesSent
          )
      </insert-query>
    </database-target>
  </target>
  
  <error-target>
    <database-target connection-name="weblog_demo">
      <truncate-query>
        truncate table weblog_event_incoming_p2_err
      </truncate-query>
      <insert-query>
       insert into weblog_event_incoming_p2_err (
          error_time, server_host, request_timestamp, class_name,
          field, field_value, details , document_url, document_line, document_column 
       )values (
          current_timestamp, :domain, to_timestamp(:time,'DD/Mon/YYYY:HH24:MI:SS'), :class_name,
          :field, :value, :details, :document_url, :document_line, :document_column
       )
      </insert-query>
    </database-target>      
  </error-target>

  <blocks>
    <set apply-to="virtualhost" value="bigdata.sztaki.hu" />
    <block-ref id="weblogparser:parse" version="1"/>
    
    <!-- Consider relevant hits only -->
    <block-ref id="weblog-events:determine.basic-events" version="1"/>
    <block-ref id="weblog-events:filter.eventless-records" version="1"/>

    <!-- Normalize request url -->
    <copy apply-to="requestUrl" from="requestUrlFull"/>
    <block-ref id="url-normalize:main" version="1.0-skipnulls">
      <map from="requestUrl" to="url" />
    </block-ref>    

    <!-- Create fields needed by the userid extension -->
    <datetime-to-milliseconds apply-to="timeInMillis" from="time" pattern="dd/MMM/yyyy:HH:mm:ss Z"/>
    <block-ref id="userid:preprocess" version="1"/>
    
    <if>
      <equals apply-to="bytesSent" value="-"/>
      <then>
        <set apply-to="bytesSent" value="0"/>
      </then>
    </if>
  </blocks>

</process>
