<?xml version="1.0" encoding="UTF-8"?>
<process xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <source>
    <weblog-file-source name="cli"/>
  </source>

  <target>
    <database-target connection-name="weblog_demo">
      <truncate-query>
        truncate table weblog_event_incoming_p2
      </truncate-query>
      <insert-query numeric-fields-to-convert="bytesSent,status,visitorRefererId,visitorCookieId">
        insert into weblog_event_incoming_p2 (
            virtual_host, request_time, event_group, event,
            visitor_referer_id, visitor_cookie_id, visitor_ip, 
            http_status_code, inet_protocol, http_method, 
            http_request, http_request_cookie, http_response_cookie, 
            request_url, request_url_parameter, request_url_extension,
            referer_url, referer_url_parameter, referer_url_extension,
            agent_string, auth_user, bytes_sent
        )
        values (
           :virtualhost, to_timestamp(:time,'DD/Mon/YYYY:HH24:MI:SS'), :eventGroup, :event,
           :visitorRefererId, :visitorCookieId, :clientip,
           :status, :requestProtType, :requestProtMethod,
           :request, :requestCookie, :responseCookie, 
           :requestUrl, :requestUrlParameter, :requestUrlExtension, 
           :refererUrl, :refererUrlParameter, :refererUrlExtension, 
           :userAgent, :user, :bytesSent
          )
      </insert-query>
    </database-target>
  </target>
  
  <error-target>
    <database-target connection-name="weblog_demo">
      <truncate-query>
        truncate table weblog_event_incoming_p2_err
      </truncate-query>
      <insert-query>
       insert into weblog_event_incoming_p2_err (
          error_time, server_host, request_timestamp, class_name,
          field, field_value, details , document_url, document_line, document_column 
       )values (
          current_timestamp, :domain, to_timestamp(:time,'DD/Mon/YYYY:HH24:MI:SS'), :class_name,
          :field, :value, :details, :document_url, :document_line, :document_column
       )
      </insert-query>
    </database-target>      
  </error-target>

  <blocks>
    <block-ref id="weblogparser:parse" version="1"/>
    
    <!-- Consider relevant hits only -->
    <block-ref id="weblog-events:determine.basic-events" version="1"/>
    <block-ref id="weblog-events:filter.eventless-records" version="1"/>

    <!-- Normalize request url -->
    <copy apply-to="requestUrl" from="requestUrlFull"/>
    <block-ref id="url-normalize:main" version="1.0-skipnulls">
      <map from="requestUrl" to="url" />
    </block-ref>    

    <!-- Normalize referer url -->
    <if>
      <equals apply-to="refererUrlFull" value="-" />
      <then>
        <set-null apply-to="refererUrlFull" />
      </then>
    </if>
    <copy apply-to="refererUrl" from="refererUrlFull"/>
    <block-ref id="url-normalize:main" version="1.0-skipnulls">
      <map from="refererUrl" to="url" />
    </block-ref>
    
    <!-- Create fields needed by the userid extension -->
    <datetime-to-milliseconds apply-to="timeInMillis" from="time" pattern="dd/MMM/yyyy:HH:mm:ss Z"/>
    <block-ref id="userid:preprocess" version="1"/>
    
    
    <!-- Set referer tracking id -->
    <block-ref id="userid:assign.visitorrefererid" version="1"/>
    <!-- Set cookie tracking id -->
    <block-ref id="userid:assign.visitorcookieid" version="1"/>
    
    <add-cookie-referer-data connection-name="userdb"/>
    
    <if>
      <equals apply-to="bytesSent" value="-"/>
      <then>
        <set apply-to="bytesSent" value="0"/>
      </then>
    </if>
  </blocks>

</process>
