<?xml version="1.0" encoding="UTF-8"?>
<process xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="urn:hu.sztaki.ilab.longneck:1.0 file:/home/lbendig/projects/longneck/longneck-lookup/src/main/resources/META-INF/schema/longneck-lookup.xsd">

  <source>
    <database-source connection-name="weblog_demo">
      <query>
        select 
          bytes_sent as "bytesSent"
          , request_prot_type as "requestProtType"
          , user_agent as "userAgent"
          , response_cookie as "responseCookie"
          , "IDENTITY" as "identity"
          , "TIME" as "time"
          , request_prot_method as "requestProtMethod"
          , request as "request"
          , domain as "domain"
          , host as "host"
          , status as "status"
          , request_url_extension as "requestUrlExtension"
          , request_url as "requestUrl"
          , request_url_url_param as "requestUrlUrlParam"
          , request_url_normalized as "requestUrlNormalized"
          , request_cookie as "requestCookie"
          , referer as "referer"
          , referer_url_param as "refererUrlParam"
          , referer_normalized as "refererNormalized"
          , "USER" as "user"
          , apache_cookie as "apacheCookie"
          , google_cookie as "googleCookie"
          , time_in_millis as "timeInMillis"
          , ip_and_user_agent_hash as "ipAndUserAgentHash"
          , visitor_referer_id as "visitorRefererId"
          , visitor_cookie_id as "visitorCookieId"        
        from weblog_event_incoming_pass2
      </query>
    </database-source>
  </source>

  <target>
    <database-target connection-name="weblog_demo">
      <truncate-query>
          delete from weblog_event_incoming_test
      </truncate-query>
      
      <insert-query>
        insert into weblog_event_incoming_test (
        request_timestamp
       ,http_request
       ,request_url
       ,request_url_normalized
       ,referer
       ,referer_normalized
       )values (
        to_timestamp_tz(:time,'DD/MONTH/YYYY:HH24:MI:SS FFTZH:TZM','NLS_DATE_LANGUAGE= AMERICAN')
       ,:request
       ,:requestUrl
       ,:requestUrlNormalized
       ,:referer
       ,:refererNormalized
       )
      </insert-query>
  
    </database-target>
  </target>

  <error-target>
    <database-target connection-name="weblog_demo">
      <truncate-query>   
        delete from weblog_event_incoming_err
      </truncate-query>
      <insert-query>
       insert into weblog_event_incoming_err (
        field
       ,field_value
       ,details
       ,server_host
       ,request_timestamp
       ,document_url
       ,document_line
       ,document_column
       ,class_name
       )values (
        :field
       ,:value
       ,:details
       ,:domain
       ,to_timestamp_tz(:time,'DD/MONTH/YYYY:HH24:MI:SS FFTZH:TZM','NLS_DATE_LANGUAGE= AMERICAN')
       ,:document_url
       ,:document_line
       ,:document_column
       ,:class_name
       )
      </insert-query>
    </database-target>
  </error-target>

  <blocks>  
    <!-- Normalize request url -->
    <copy apply-to="requestUrlNormalized" from="requestUrl"/>
    <block-ref id="url-normalize:main" version="1.0-skipnulls">
      <map from="requestUrlNormalized" to="url" />
    </block-ref>

    <if>
      <equals apply-to="referer" value="-" />
      <then>
        <set-null apply-to="referer" />
      </then>
    </if>


    <!-- Normalize referrer url -->
    <copy apply-to="refererNormalized" from="referer"/>
    <block-ref id="url-normalize:main" version="1.0-skipnulls">
      <map from="refererNormalized" to="url" />
    </block-ref>

  </blocks>

</process>
