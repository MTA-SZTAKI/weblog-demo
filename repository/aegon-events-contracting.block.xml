<?xml version="1.0" encoding="UTF-8"?>
<block-package xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="urn:hu.sztaki.ilab.longneck:1.0 http://dms.sztaki.hu/longneck/schema/longneck-block.xsd">
  
  <!-- 
    Events are identfied based on the referer url; spacial URL pages indicate business events.
    AEGON's contract-related events are handled here.
    
    Deals with web event lines only.
    
    IN:   eventGroup, refererUrl, requestUrl
    OUT:  eventGroup, event
  -->
  <block id="clone-event" version="1.2">
    
    <if>
      <and>      
        <match apply-to="eventGroup" regexp="^web$"/>        
        <match apply-to="requestUrl" regexp="^.*wsf.*crm_pos=([^&amp;$]*).*$"/>
        <not>
          <or>
            <match apply-to="refererUrl" regexp="panaszbejelentes"/>
            <match apply-to="refererUrl" regexp="online-fizetes"/>
          </or>          
        </not>
      </and>
      
      <then>
        <clone-record set-field="isProductEvent" set-value="true" />
        
        <!-- further processing only for cloned records -->
        <if> 
          <exists apply-to="isProductEvent" /> 
          <then>
            <set apply-to="event" value="" />

            <!-- ismeretlen termék, külső oldalról --> 
            <set apply-to="eventGroup" value="szerződés: ismeretlen termék" />

            <match-extract apply-to="requestUrl" regexp="^.*crm_pos=([^&amp;$]*).*$" >
              <copy apply-to="event" from="$1" />
            </match-extract>

            <!-- Lakasbiztositas -->
            <if>
              <match apply-to="refererUrl" regexp="lakasbiztositas"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: lakásbiztosítás" />
              </then>
            </if>

            <!-- Balesetbiztositas -->
            <if>
              <match apply-to="refererUrl" regexp="balesetbiztositas"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: balesetbiztosítás" />
              </then>
            </if>     

            <!-- kötelező -->
            <if>
              <match apply-to="refererUrl" regexp="kotelezo-biztositas"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: kötelező biztosítás" />
              </then>
            </if>             

            <!-- nyugdíj -->
            <if>
              <or>
                <match apply-to="refererUrl" regexp="onkentes_nyugdijpenztar"/>
                <match apply-to="refererUrl" regexp="nyugdijkalkulator"/>            
              </or>
              <then>
                <set apply-to="eventGroup" value="szerződés: önkéntes nyugdíjpénztár" />
              </then>
            </if>          

            <!-- mini -->
            <if>
              <match apply-to="refererUrl" regexp="mini-biztositas"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: mini biztosítás" />
              </then>
            </if>          

            <!-- utas -->
            <if>
              <match apply-to="refererUrl" regexp="utasbiztositas"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: utasbiztosítás" />
              </then>
            </if>          

            <!-- gépjármű -->
            <if>
              <match apply-to="refererUrl" regexp="gepjarmu-biztositas"/>          
              <then>
                <set apply-to="eventGroup" value="szerződés: gépjármű biztosítás" />
              </then>
            </if>          

            <!-- casco -->
            <if>
              <match apply-to="refererUrl" regexp="casco"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: casco biztosítás" />
              </then>
            </if>          
            
            <!-- casco: motor -->
            <if>
              <match apply-to="refererUrl" regexp="casco(.*)fajta=30"/> 
              <then>
                <set apply-to="eventGroup" value="szerződés: motor casco biztosítás" />
              </then>
            </if>          
                       
            <!-- kisállat -->
            <if>
              <or>
                <match apply-to="refererUrl" regexp="kisallat-biztositas"/>
                <match apply-to="refererUrl" regexp="utazzkutyaddal"/>
              </or>          
              <then>
                <set apply-to="eventGroup" value="szerződés: kisállat biztosítás" />
              </then>
            </if>          

            <!-- élet -->
            <if>
              <match apply-to="refererUrl" regexp="eletbiztositas"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: életbiztosítás" />
              </then>
            </if>   

            <!-- allin -->
            <if>
              <match apply-to="refererUrl" regexp="allin-kalkulator"/>
              <then>
                <set apply-to="eventGroup" value="szerződés: allin biztosítás" />
              </then>
            </if>   

          </then>
        </if>
      </then>
      
    </if>
              
  
  </block>


</block-package>