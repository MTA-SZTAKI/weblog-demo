<?xml version="1.0" encoding="UTF-8"?>
<block-package xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="urn:hu.sztaki.ilab.longneck:1.0 http://dms.sztaki.hu/longneck/schema/longneck-block.xsd">
  
  
  <!-- 
    Events are identfied based on the referer url; spacial URL pages indicate business events.
    AEGON's miscellenous small events are handled here.
    
    Deals with web event lines only.
    
    IN:   eventGroup, refererUrl, requestUrl
    OUT:  eventGroup, event
  -->
  <block id="clone-event" version="1.2">
    
    <if>
      <match apply-to="eventGroup" regexp="^web$"/>        
      <then>
        
        <!-- online fizetés --> 
        <if>
          <match apply-to="refererUrl" regexp="online-fizetes-tranzakcio.html"/> 
          <then>
            <clone-record set-field="isPayment" set-value="true" />
            <if> 
              <exists apply-to="isPayment" /> 
              <then>
                <set apply-to="eventGroup" value="online fizetés" />
                <set apply-to="event" value="indít" />
              </then>
            </if>
          </then>
        </if>
        
        <if>
          <and>
            <match apply-to="refererUrl" regexp="online-fizetes-tranzakcio.html"/>
            <match apply-to="requestUrl" regexp="^.*wsf.*crm_pos=([^&amp;$]*).*$"/>
          </and>          
          <then>
            <clone-record set-field="isPayment" set-value="true" />
            <if> 
              <exists apply-to="isPayment" /> 
              <then>
                <set apply-to="eventGroup" value="online fizetés" />
                <match-extract apply-to="requestUrl" regexp="^.*crm_pos=([^&amp;$]*).*$" >
                  <copy apply-to="event" from="$1" />
                </match-extract>
              </then>
            </if>
          </then>
        </if>        
        
        <!-- panaszbejelentés --> 
        <if>
          <match apply-to="requestUrl" regexp="panaszbejelentes/panaszbejelentes"/>
          <then>
            <clone-record set-field="isComplaint" set-value="true" />
            <if> 
              <exists apply-to="isComplaint" /> 
              <then>
                <set apply-to="eventGroup" value="panaszbejelentés" />
                <set apply-to="event" value="indít" />
              </then>
            </if>
          </then>
        </if>
        
        <if>
          <and>
            <match apply-to="refererUrl" regexp="panaszbejelentes"/>
            <match apply-to="requestUrl" regexp="^.*wsf.*crm_pos=([^&amp;$]*).*$"/>
          </and>          
          <then>
            <clone-record set-field="isComplaint" set-value="true" />
            <if> 
              <exists apply-to="isComplaint" /> 
              <then>
                <set apply-to="eventGroup" value="panaszbejelentés" />
                <match-extract apply-to="requestUrl" regexp="^.*crm_pos=([^&amp;$]*).*$" >
                  <copy apply-to="event" from="$1" />
                </match-extract>
              </then>
            </if>
          </then>
        </if>

      </then>
      
    </if>

    
  </block>


</block-package>