<?xml version="1.0" encoding="UTF-8"?>
<block-package xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!--
    Determine basic events.
    Events with 2XX status code and a page-related URL extension (eg. html, php) are page views.
    Events with 3XX, 4XX, 5XX status codes are categorized as redirect, error, error respectively.
    Redirects are valid only for page-related URLs.

    IN : requestUrl, requestUrlExtension, status
    OUT: eventGroup, event
  -->
  <block id="determine.basic-events">
    <if>
      <not>
        <exists apply-to="requestUrlExtension" />
      </not>
      <then>
        <set apply-to="requestUrlExtension" value="" />
      </then>
    </if>
    <!-- basic pageview events -->
    <if>
      <match apply-to="status" regexp="[23]\d{2}"/>
      <not>
        <match apply-to="requestUrl" regexp="ajax\.php"/>
      </not>
      <or>
        <equals apply-to="requestUrlExtension" value="" />
        <equals apply-to="requestUrlExtension" value="js.php" />
        <equals apply-to="requestUrlExtension" value="jsp" />
        <equals apply-to="requestUrlExtension" value="php" />
        <equals apply-to="requestUrlExtension" value="html" />
      </or>
      <then>
        <set apply-to="eventGroup" value="web"/>
        <if>
          <match apply-to="status" regexp="2\d{2}"/>
          <then>
            <set apply-to="event" value="pageview"/>
          </then>
          <else>
            <!-- redirects: only for page requests -->
            <set apply-to="event" value="redirect"/>
          </else>
        </if>
      </then>
    </if>
    <!-- erroneous events: not only for page requests -->
    <if>
      <match apply-to="status" regexp="[45]\d{2}"/>
      <then>
        <set apply-to="eventGroup" value="web"/>
        <set apply-to="event" value="error"/>
      </then>
    </if>
  </block>

  <!--
    Filters non-pageview log lines.
    This block filters non-pageview log lines based on the requestUrlExtension parameter.
    IN: requestUrlExtension 
  -->
  <block id="filter.eventless-records">
    <if>
      <is-empty apply-to="eventGroup"/>
      <then>
        <filter/>
      </then>
    </if>
  </block>

</block-package>
