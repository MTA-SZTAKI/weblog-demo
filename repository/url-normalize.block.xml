<?xml version="1.0" encoding="UTF-8"?>
<block-package xmlns="urn:hu.sztaki.ilab.longneck:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- 
    Main block that invokes URL normalization 
    References: http://en.wikipedia.org/wiki/URL_normalization 
    Not implemented yet:
      Removing dot-segments
      Removing directory index
      Sorting the query parameters of active pages
      Removing unused query variables
      Removing default query parameters
  -->
  <block id="main" version="1.0">

    <input-constraints summary="">
      <and>
        <not-null apply-to="url" />
        <not>
          <equals apply-to="url" value="-" />
        </not>
      </and>
    </input-constraints>

    <block-ref id="url-normalize:http_prefix" version="1.0" />
    <block-ref id="url-normalize:remove_www" version="1.0" />
    <block-ref id="url-normalize:remove_double_slashes" version="1.0" />
    <block-ref id="url-normalize:remove_fragment" version="1.0" />
    <block-ref id="url-normalize:trailing_slash" version="1.0" />
    <block-ref id="url-normalize:remove_default_port" version="1.0" />

  </block>

  <!-- Main block, skips null fields. -->
  <block id="main" version="1.0-skipnulls">
    <if>
      <not-null apply-to="url"/>
      <then>
        <block-ref id="url-normalize:http_prefix" version="1.0" />
        <block-ref id="url-normalize:remove_www" version="1.0" />
        <block-ref id="url-normalize:remove_double_slashes" version="1.0" />
        <block-ref id="url-normalize:remove_fragment" version="1.0" />
        <block-ref id="url-normalize:trailing_slash" version="1.0" />
        <block-ref id="url-normalize:remove_default_port" version="1.0" />
      </then>
    </if>
  </block>

  <!-- Convert the scheme to lowecase and apply http everywhere -->
  <block id="http_prefix" version="1.0">
    <if>
      <match apply-to="url" regexp="^(?i)http.*$" />
      <then>
        <replace-all apply-to="url" regexp="^(?i)(https?)\:" replacement="http:" />
      </then>
      <else>
        <set apply-to="$prefix" value="http://"/>
        <implode apply-to="url" sources="$prefix url" glue=""/>
      </else>
    </if>
  </block>


  <!-- Remove "www" as the first (or last in hierarchy) domain label. -->
  <block id="remove_www" version="1.0">
    <if>
      <match apply-to="url" regexp="^http\:\/\/www.*$" />
      <then>
        <replace-all apply-to="url" regexp="^http\:\/\/www\." replacement="http://" />
      </then>
    </if>
  </block>

  <!-- Remove duplicate slashes -->
  <block id="remove_double_slashes" version="1.0">
    <if>
      <match apply-to="url" regexp="^.*(?:[^:])([/]{2,}).*$" />
      <then>
        <replace-all apply-to="url" regexp="(?&lt;!:)//" replacement="/" />
      </then>
    </if>
  </block>

  <!-- Remove the fragment -->
  <block id="remove_fragment" version="1.0">
    <if>
      <match apply-to="url" regexp="^.*(#.*)$" />
      <then>
        <replace-first apply-to="url" regexp="(#.*)" replacement="" />
      </then>
    </if>
  </block>

 <!-- Add trailing / -->
  <block id="trailing_slash" version="1.0">
    <if>
      <and>
        <not>
          <match apply-to="url" regexp="^.*(=).*$" />
        </not>
        <match apply-to="url" regexp="^.*(\?)$" />
      </and>
      <then>
        <replace-first apply-to="url" regexp="(\?)" replacement="/" />
      </then>
      <else>
        <if>
          <and>
            <not>
              <match apply-to="url" regexp="^.*(\?).*$" />
            </not>
            <not>
              <match apply-to="url" regexp="^.*(\/)$" />
            </not>
            <not>
              <match apply-to="url" regexp="^.*\/\/.*\/.*\.[a-zA-Z0-9]*$" />
            </not>
          </and>
          <then>
            <add-postfix apply-to="url" text="/" />
          </then>
        </if>
      </else>
    </if>
  </block>

  <!-- Remove the default port -->
  <block id="remove_default_port" version="1.0">
    <if>
      <or>
        <match apply-to="url" regexp="^.*(\:80).*$" />
        <match apply-to="url" regexp="^.*(\:80)$" />
      </or>
      <then>
        <replace-first apply-to="url" regexp="(\:80)" replacement="" />
      </then>
    </if>
  </block>

</block-package>